{% extends 'base.html.twig' %}

{% block title %}Pasarela de pago{% endblock %}

{% block body %}
<div class="container mt-4">
    <h1 class="mb-3">Pasarela de Pago</h1>

    {# --- RESUMEN DEL PEDIDO (opcional si lo usas) -- #}
    {% if pedido is defined %}
        <div class="mb-4 p-3 border rounded">
            <h5>Resumen del pedido</h5>
            <p><strong>Total:</strong> {{ pedido.total }} €</p>
        </div>
    {% endif %}

    <form action="{{ path('procesar_pago') }}" method="POST">

        <!-- SELECCIÓN DE TARJETA -->
        <div class="mb-4">
            <label class="form-label fw-semibold">Método de pago</label>

            {% if tarjetas is defined and tarjetas|length > 0 %}
                <select class="form-select" name="tarjeta_guardada" id="select-tarjeta">
                    <option value="nueva">➕ Usar tarjeta nueva</option>
                    {% for tarjeta in tarjetas %}
                        <option value="{{ tarjeta.id }}">
                            **** **** **** {{ tarjeta.numero|slice(-4) }} ({{ tarjeta.fecha_caducidad }})
                        </option>
                    {% endfor %}
                </select>
            {% else %}
                <div class="alert alert-info p-2">
                    No tienes tarjetas guardadas. Introduce una tarjeta nueva.
                </div>
                <input type="hidden" name="tarjeta_guardada" value="nueva">
            {% endif %}
        </div>

        <!-- FORM TARJETA NUEVA -->
        <div id="form-tarjeta-nueva" class="border rounded p-3 {% if tarjetas is defined and tarjetas|length > 0 %}d-none{% endif %}">
            <h6 class="mb-3">Datos de la tarjeta</h6>

            <div class="mb-3">
                <label class="form-label">Número de tarjeta</label>
                <input type="text" name="numero" class="form-control" maxlength="19" placeholder="XXXX XXXX XXXX XXXX">
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Fecha caducidad</label>
                    <input type="month" name="fecha_caducidad" class="form-control">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">CVV</label>
                    <input type="text" name="cvv" maxlength="4" class="form-control" placeholder="123">
                </div>
            </div>

            <div class="form-check mt-2">
                <input class="form-check-input" type="checkbox" name="guardar_tarjeta" value="1" id="guardarTarjetaCheck">
                <label class="form-check-label" for="guardarTarjetaCheck">
                    Guardar esta tarjeta para futuros pagos
                </label>
            </div>
        </div>

        <button type="submit" class="btn btn-success mt-4">
            Confirmar Pago
        </button>

    </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const select = document.getElementById("select-tarjeta");
    const formNueva = document.getElementById("form-tarjeta-nueva");

    if (select) {
        select.addEventListener("change", function() {
            if (this.value === "nueva") {
                formNueva.classList.remove("d-none");
            } else {
                formNueva.classList.add("d-none");
            }
        });
    }
});
</script>

{% endblock %}
