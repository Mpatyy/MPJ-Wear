{% extends 'base.html.twig' %}

{% block title %}Nueva contraseña
{% endblock %}

{% block body %}
	<div class="row justify-content-center">
		<div class="col-md-6 col-lg-4">
			<h1 class="mb-4 text-center">Nueva contraseña</h1>

			{% if app.user %}
				<span id="user-email" data-email="{{ app.user.email }}" class="d-none"></span>
			{% endif %}

			{{ form_start(resetForm, {
            attr: { class: 'card p-4 shadow-sm' }
        }) }}

			<div class="mb-3">
				{{ form_label(resetForm.plainPassword.first, 'Nueva contraseña', {
                    label_attr: { class: 'form-label fw-semibold mb-2' }
                }) }}
                {{ form_widget(resetForm.plainPassword.first, {
                    attr: {
                        class: 'form-control',
                        id: 'change_password_form_plainPassword_first'
                    }
                }) }}
				{{ form_errors(resetForm.plainPassword.first) }}

				<ul class="mt-2 small" id="password-rules">
					<li id="rule-length" class="text-danger">Mínimo 8 caracteres</li>
					<li id="rule-lower" class="text-danger">Al menos una letra minúscula</li>
					<li id="rule-upper" class="text-danger">Al menos una letra mayúscula</li>
				</ul>
			</div>

			<div class="mb-3">
				{{ form_label(resetForm.plainPassword.second, 'Repetir contraseña', {
                    label_attr: { class: 'form-label fw-semibold mb-2' }
                }) }}
                {{ form_widget(resetForm.plainPassword.second, {
                    attr: {
                        class: 'form-control',
                        id: 'change_password_form_plainPassword_second'
                    }
                }) }}
				{{ form_errors(resetForm.plainPassword.second) }}
			</div>

			<button type="submit" class="btn btn-success w-100 mt-2">
				Actualizar contraseña
			</button>

			{{ form_end(resetForm) }}
		</div>
	</div>

    <script>
document.addEventListener('DOMContentLoaded', function () {
    const password1 = document.getElementById('change_password_form_plainPassword_first');
    const password2 = document.getElementById('change_password_form_plainPassword_second');

    const ruleLength = document.getElementById('rule-length');
    const ruleLower  = document.getElementById('rule-lower');
    const ruleUpper  = document.getElementById('rule-upper');

    if (!password1 || !password2 || !ruleLength || !ruleLower || !ruleUpper) return;

    function countRules(value) {
        let ok = 0;
        if (value.length >= 8) ok++;
        if (/[a-z]/.test(value)) ok++;
        if (/[A-Z]/.test(value)) ok++;
        return ok;
    }

    function passwordsMatch(p1, p2) {
        return p1 === p2 && p1 !== '';
    }

    function updatePasswordRules(value) {
        if (value.length >= 8) {
            ruleLength.classList.remove('text-danger');
            ruleLength.classList.add('text-success');
        } else {
            ruleLength.classList.remove('text-success');
            ruleLength.classList.add('text-danger');
        }

        if (/[a-z]/.test(value)) {
            ruleLower.classList.remove('text-danger');
            ruleLower.classList.add('text-success');
        } else {
            ruleLower.classList.remove('text-success');
            ruleLower.classList.add('text-danger');
        }

        if (/[A-Z]/.test(value)) {
            ruleUpper.classList.remove('text-danger');
            ruleUpper.classList.add('text-success');
        } else {
            ruleUpper.classList.remove('text-success');
            ruleUpper.classList.add('text-danger');
        }
    }

    function updatePassword1() {
        const value = password1.value;
        const ok = countRules(value);

        password1.classList.remove('is-invalid', 'is-valid', 'border-danger', 'border-warning', 'border-success');

        if (ok === 0) {
            password1.classList.add('is-invalid', 'border-danger');
        } else if (ok === 1 || ok === 2) {
            password1.classList.add('border-warning');
        } else if (ok === 3) {
            password1.classList.add('is-valid', 'border-success');
        }

        updatePasswordRules(value);
    }

    function updatePassword2() {
        password2.classList.remove('is-invalid', 'is-valid', 'border-danger', 'border-success');
        if (passwordsMatch(password1.value, password2.value)) {
            password2.classList.add('is-valid', 'border-success');
        } else {
            password2.classList.add('is-invalid', 'border-danger');
        }
    }

    password1.addEventListener('input', function () {
        updatePassword1();
        updatePassword2();
    });

    password2.addEventListener('input', function () {
        updatePassword2();
    });

    updatePassword1();
    updatePassword2();
});
</script>


{% endblock %}
