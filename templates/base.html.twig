<!DOCTYPE html>
<html lang="es">
	<head>
		<meta charset="UTF-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1"/>

		<title>
			{% block title %}Mi Tienda MPJ{% endblock %}
		</title>

		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
		<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

		<link
		  rel="stylesheet"
		  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
		  referrerpolicy="no-referrer"
		/>

		<style>
			html, body { background: #fff !important; min-height: 100%; }

			/* Lupa */
			.btn-lupa {
				border: 0;
				background: transparent;
				color: #fff;
				padding: 6px 10px;
				line-height: 1;
				cursor: pointer;
				display: inline-flex;
				align-items: center;
				justify-content: center;
			}
			.btn-lupa i { font-size: 16px; opacity: .9; }
			.btn-lupa:hover { opacity: .85; }

			/* Para que no tape el navbar fixed */
			main.container {
				padding-top: 80px;
			}

			.nav-link i {
				transition: opacity .15s ease;
			}
			.nav-link:hover i {
				opacity: .8;
			}

			/* Dropdown perfil: que no parezca link azul raro */
			.dropdown .nav-link {
				text-decoration: none;
			}
			.dropdown .nav-link:focus {
				box-shadow: none;
			}

			/* ===== BUSCAR ===== */
			.zara-buscar {
				display: flex;
				align-items: center;
				gap: 8px;

				background: transparent;
				border: 0;
				padding: 6px 8px;

				color: #fff;
				cursor: pointer;

				font-size: 12px;
				font-weight: 500;
				letter-spacing: 0.08em;
				text-transform: uppercase;
			}

			.zara-buscar i {
				font-size: 15px;
				opacity: 0.9;
			}

			.zara-buscar span {
				line-height: 1;
			}

			.zara-buscar:hover {
				opacity: 0.75;
			}

			/* Espaciado fino entre acciones del header */
			.header-acciones > * {
				margin-left: 18px;
			}


		</style>

		<link rel="stylesheet" href="/build/app.css">
		{% block stylesheets %}{% endblock %}
	</head>

	<body>
		<header>
			<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
				<div class="container-fluid px-4">

					<div class="d-flex align-items-center">
						<a class="navbar-brand me-4" href="{{ path('home') }}">
							<img src="{{ asset('images/logo.png') }}" alt="MPJ" style="height: 28px;">
						</a>

						<ul class="navbar-nav mb-2 mb-lg-0">
							<li class="nav-item">
								<a class="nav-link" href="{{ path('producto_listado') }}">Productos</a>
							</li>
						</ul>
					</div>

					{# ================= DERECHA ================= #}
					<div class="d-flex align-items-center gap-4 ms-auto">

						{# BUSCAR (Zara style) #}
						<button
							type="button"
							class="btn-lupa d-flex align-items-center gap-2"
							id="btn-abrir-buscador"
							aria-label="Abrir buscador"
						>
							<i class="fa-solid fa-magnifying-glass"></i>
							<span>Buscar</span>
						</button>

						{% set carrito = app.session.get('carrito', []) %}
						{% set totalCarrito = 0 %}
						{% for item in carrito %}
							{% set totalCarrito = totalCarrito + item.cantidad %}
						{% endfor %}

						<a class="nav-link position-relative text-white" href="{{ path('carrito_ver') }}" title="Carrito">
							<i class="bi bi-cart3 fs-5"></i>
							{% if totalCarrito > 0 %}
								<span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
									{{ totalCarrito }}
								</span>
							{% endif %}
						</a>

						{% if app.user %}
							<div class="dropdown">
								<button class="btn btn-dark dropdown-toggle d-flex align-items-center gap-2" data-bs-toggle="dropdown" aria-expanded="false">
									<i class="bi bi-person-circle fs-5"></i>
								</button>
								<ul class="dropdown-menu dropdown-menu-end">
									<li><a class="dropdown-item" href="{{ path('perfil') }}">Mi perfil</a></li>
									<li><hr class="dropdown-divider"></li>
									<li><a class="dropdown-item text-danger" href="{{ path('app_logout') }}">Cerrar sesión</a></li>
								</ul>
							</div>
						{% else %}
							<a class="btn btn-outline-light btn-sm" href="{{ path('app_login') }}">Iniciar sesión</a>
						{% endif %}
					</div>
				</div>
			</nav>

			<div id="react-buscador-avanzado"></div>
		</header>

		{# ✅ FLASH (solo success/error) -> con Ver carrito / Seguir comprando #}
		<div class="flash-carrito-container" id="flash-carrito-container">
			{% for label, messages in app.flashes %}
				{% for message in messages %}
					{% if label == 'success' %}
						<div class="flash-carrito" id="flash-toast" role="status" aria-live="polite">
							<button type="button" class="flash-cerrar" aria-label="Cerrar">×</button>

							<div class="flash-texto">{{ message }}</div>

							<div class="flash-acciones">
								<a href="{{ path('carrito_ver') }}" class="flash-btn negro">Ver carrito</a>
								<button type="button" class="flash-btn" data-accion="seguir">Seguir comprando</button>
							</div>
						</div>

					{% elseif label == 'error' %}
						<div class="flash-carrito error" id="flash-toast" role="alert">
							<button type="button" class="flash-cerrar" aria-label="Cerrar">×</button>
							<div class="flash-texto">{{ message }}</div>
						</div>
					{% endif %}
				{% endfor %}
			{% endfor %}
		</div>

		{% block hero %}{% endblock %}

		<main class="container mt-4">
			{% block body %}{% endblock %}
		</main>

		<footer class="text-center mt-4 mb-4">
			<p>© 2025 Mi Tienda MPJ - Todos los derechos reservados</p>
		</footer>

		<script src="/build/runtime.js"></script>
		<script src="/build/app.js"></script>
		{% block javascripts %}{% endblock %}
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

		<script>
			(function () {
				const cont = document.getElementById('flash-carrito-container');
				if (!cont) return;

				const flash = cont.querySelector('#flash-toast');
				if (!flash) return;

				/* ✅ FIX: si vuelves con la flecha (bfcache), el navegador “revive” el toast.
				   Lo eliminamos para que no vuelva a aparecer. */
				window.addEventListener('pageshow', (event) => {
					if (event.persisted) {
						const c = document.getElementById('flash-carrito-container');
						if (c) c.remove();
					}
				});

				const icono = document.getElementById('icono-carrito');

				function posicionar() {
					if (!icono) return;

					const r = icono.getBoundingClientRect();
					const margin = 12;

					// Medimos el toast
					const w = flash.offsetWidth;

					// Alinear el final del toast con el final del icono
					let left = (r.right + window.scrollX) - w;

					// Clamp para que no se salga
					const minLeft = window.scrollX + margin;
					const maxLeft = window.scrollX + window.innerWidth - w - margin;
					left = Math.max(minLeft, Math.min(left, maxLeft));

					cont.style.left = left + 'px';
					cont.style.top  = (r.bottom + window.scrollY + 10) + 'px';

					// Piquito: apunta al centro del icono dentro del toast
					const centroIconoEnPantalla = r.left + (r.width / 2);
					const centroIconoDentroToast = centroIconoEnPantalla - (left - window.scrollX);
					const picoLeft = Math.max(14, Math.min(centroIconoDentroToast - 7, w - 18));
					flash.style.setProperty('--pico-left', picoLeft + 'px');
				}

				posicionar();
				window.addEventListener('resize', posicionar);

				// Cerrar
				const btnCerrar = flash.querySelector('.flash-cerrar');
				if (btnCerrar) btnCerrar.addEventListener('click', () => cont.remove());

				// Seguir comprando
				const btnSeguir = flash.querySelector('[data-accion="seguir"]');
				if (btnSeguir) btnSeguir.addEventListener('click', () => cont.remove());

				// Auto ocultar (más lento)
				setTimeout(() => {
					if (!cont.isConnected) return;
					flash.style.opacity = '0';
					flash.style.transform = 'translateY(-6px)';
					flash.style.transition = 'opacity .18s ease, transform .18s ease';
					setTimeout(() => cont.remove(), 220);
				}, 6500);
			})();

			/* ✅ Extra: por si el navegador no marca event.persisted pero sí vuelve del historial,
			   también limpiamos el toast al volver atrás/adelante. */
			window.addEventListener('popstate', () => {
				const c = document.getElementById('flash-carrito-container');
				if (c) c.remove();
			});
		</script>
	</body>
</html>
