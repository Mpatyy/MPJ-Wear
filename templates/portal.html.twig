{% extends 'base.html.twig' %}

{% block title %}Mi área{% endblock %}

{% block body %}
<style>
  /* ===== PERFIL (look limpio/premium) ===== */
  .mpj-card{
    border: 1px solid rgba(17,17,17,.08);
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,.06);
    overflow: hidden;
  }
  .mpj-soft{
    background: #fafafa;
    border-radius: 16px;
  }
  .mpj-title{
    letter-spacing: .02em;
  }
  .mpj-muted{
    color: rgba(17,17,17,.62);
  }
  .mpj-avatar{
    width: 46px;
    height: 46px;
    border-radius: 999px;
    background:#111;
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight: 700;
    letter-spacing:.03em;
    flex: 0 0 auto;
  }

  /* Menu lateral */
  .mpj-nav .list-group-item{
    border: 0;
    border-radius: 12px !important;
    margin-bottom: 8px;
    padding: 10px 12px;
    color: rgba(17,17,17,.8);
    background: transparent;
  }
  .mpj-nav .list-group-item:hover{
    background: rgba(17,17,17,.04);
  }
  .mpj-nav .list-group-item.active{
    background:#111;
    color:#fff;
  }

  /* Pills estado */
  .mpj-pill{
    border-radius: 999px;
    padding: 6px 12px;
    font-size: 12px;
    letter-spacing: .06em;
    text-transform: uppercase;
    display:inline-flex;
    align-items:center;
    gap:6px;
  }

  /* Tabla */
  .mpj-table tr{
    cursor: pointer;
  }
  .mpj-table tr:hover{
    background: rgba(17,17,17,.03);
  }
  .mpj-table thead th{
    font-size: 12px;
    letter-spacing: .08em;
    text-transform: uppercase;
    color: rgba(17,17,17,.55);
    border-top: 0;
  }

  /* Mini cards resumen */
  .mpj-mini{
    border: 1px solid rgba(17,17,17,.08);
    border-radius: 16px;
    padding: 14px 14px;
    background:#fff;
  }
</style>

<div class="container my-4">

  {# ===== CABECERA PERFIL ===== #}
  <div class="mpj-card p-3 p-md-4 mb-4">
    <div class="d-flex align-items-center gap-3">
      <div class="mpj-avatar">
        {% if app.user and app.user.nombre %}
          {{ app.user.nombre|slice(0,1)|upper }}
        {% elseif app.user %}
          {{ app.user.email|slice(0,1)|upper }}
        {% else %}
          U
        {% endif %}
      </div>

      <div class="flex-grow-1">
        <div class="mpj-muted small">Mi cuenta</div>
        <h2 class="h4 mb-1 mpj-title">
          {% if app.user and app.user.nombre %}
            Hola, {{ app.user.nombre }}
          {% else %}
            Mi perfil
          {% endif %}
        </h2>
        {% if app.user %}
          <div class="mpj-muted small">
            {{ app.user.email }}
            {% if app.user.telefono %}
              · {{ app.user.telefono }}
            {% endif %}
          </div>
        {% endif %}
      </div>

      <div class="d-flex gap-2">
        <a href="{{ path('producto_listado') }}" class="btn btn-dark btn-sm rounded-pill px-3">
          Seguir comprando
        </a>
      </div>
    </div>
  </div>

  <div class="row g-4">
    {# ===== LATERAL ===== #}
    <div class="col-12 col-lg-3">

      <div class="mpj-card p-3 mb-3">
        <div class="fw-semibold mb-2">Mi cuenta</div>

        <div class="list-group mpj-nav">
          <a href="{{ path('perfil') }}" class="list-group-item list-group-item-action active">
            <i class="bi bi-person me-2"></i> Perfil y pedidos
          </a>

          <a href="{{ path('mis_direcciones') }}" class="list-group-item list-group-item-action">
            <i class="bi bi-geo-alt me-2"></i> Mis direcciones
          </a>

          <span class="list-group-item text-muted">
            <i class="bi bi-credit-card me-2"></i> Métodos de pago (pendiente)
          </span>

          <a href="{{ path('app_logout') }}" class="list-group-item list-group-item-action text-danger">
            <i class="bi bi-box-arrow-right me-2"></i> Cerrar sesión
          </a>
        </div>
      </div>

      {# Mini bloque “datos” compacto (opcional, queda bien) #}
      <div class="mpj-card p-3">
        <div class="fw-semibold mb-2">Datos</div>
        {% if app.user %}
          <div class="small">
            <div class="d-flex justify-content-between mb-2">
              <span class="mpj-muted">Nombre</span>
              <span class="fw-semibold">{{ app.user.nombre }}</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span class="mpj-muted">Email</span>
              <span class="fw-semibold">{{ app.user.email }}</span>
            </div>
            <div class="d-flex justify-content-between">
              <span class="mpj-muted">Teléfono</span>
              <span class="fw-semibold">{{ app.user.telefono }}</span>
            </div>
          </div>
        {% else %}
          <div class="alert alert-warning mb-0">
            No has iniciado sesión.
          </div>
        {% endif %}
      </div>

    </div>

    {# ===== CONTENIDO ===== #}
    <div class="col-12 col-lg-9">

      {# ===== RESUMEN en 2-3 mini cards ===== #}
      <div class="row g-3 mb-4">
        <div class="col-12 col-md-6">
          <div class="mpj-mini">
            <div class="mpj-muted small mb-1">Pedidos</div>
            <div class="d-flex align-items-end justify-content-between">
              <div class="h4 mb-0 fw-bold">{{ pedidos|length }}</div>
              <i class="bi bi-bag fs-4 mpj-muted"></i>
            </div>
          </div>
        </div>

        <div class="col-12 col-md-6">
          <div class="mpj-mini">
            <div class="mpj-muted small mb-1">Total gastado</div>
            <div class="d-flex align-items-end justify-content-between">
              {% if totalGastado is defined %}
                <div class="h4 mb-0 fw-bold">{{ totalGastado|number_format(2, ',', '.') }} €</div>
              {% else %}
                <div class="h4 mb-0 fw-bold">—</div>
              {% endif %}
              <i class="bi bi-currency-euro fs-4 mpj-muted"></i>
            </div>
          </div>
        </div>
      </div>

      {# ===== HISTORIAL ===== #}
      <div class="mpj-card">
        <div class="p-3 p-md-4 border-bottom" style="border-color: rgba(17,17,17,.08) !important;">
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <div class="fw-semibold">Historial de pedidos</div>
              <div class="mpj-muted small">Consulta tus compras y su estado</div>
            </div>
          </div>
        </div>

        <div class="p-3 p-md-4">
          {% if pedidos is empty %}
            <div class="mpj-soft p-4 text-center">
              <div class="mb-2">
                <i class="bi bi-bag fs-2"></i>
              </div>
              <div class="fw-semibold">Todavía no has realizado ningún pedido</div>
              <div class="mpj-muted small mb-3">Cuando compres algo, aquí aparecerá tu historial.</div>
              <a href="{{ path('producto_listado') }}" class="btn btn-dark btn-sm rounded-pill px-3">
                Ver productos
              </a>
            </div>
          {% else %}
            <div class="table-responsive">
              <table class="table align-middle mb-0 mpj-table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Fecha</th>
                    <th>Estado</th>
                    <th class="text-end">Total</th>
                  </tr>
                </thead>
                <tbody>
                  {% for pedido in pedidos %}
                    <tr onclick="window.location.href='{{ path('perfil_pedido_detalle', {'id': pedido.id}) }}'">
                      <td class="fw-semibold">#{{ pedido.id }}</td>
                      <td class="mpj-muted">{{ pedido.fecha|date('d/m/Y H:i') }}</td>
                      <td>
                        {% set estado = (pedido.estado ?? '')|lower %}
                        {% if estado == 'pagado' %}
                          <span class="badge text-bg-success mpj-pill">
                            <i class="bi bi-check2-circle"></i> Pagado
                          </span>
                        {% elseif estado == 'pendiente' %}
                          <span class="badge text-bg-warning mpj-pill">
                            <i class="bi bi-hourglass-split"></i> Pendiente
                          </span>
                        {% elseif estado == 'enviado' %}
                          <span class="badge text-bg-primary mpj-pill">
                            <i class="bi bi-truck"></i> Enviado
                          </span>
                        {% else %}
                          <span class="badge text-bg-secondary mpj-pill">
                            <i class="bi bi-info-circle"></i> {{ pedido.estado }}
                          </span>
                        {% endif %}
                      </td>
                      <td class="text-end fw-semibold">
                        {{ pedido.total|number_format(2, ',', '.') }} €
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% endif %}
        </div>
      </div>

    </div>
  </div>
</div>
{% endblock %}
